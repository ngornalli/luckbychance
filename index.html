<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Luck By Chance — Syngenta</title>
  <style>
    :root{
      --bg:#0f172a; --bg-accent:#111827; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#22c55e; --accent-2:#60a5fa; --danger:#ef4444; --shadow:0 20px 40px rgba(0,0,0,.35); --radius:16px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f3f4f6; --bg-accent:#e5e7eb; --card:#ffffff; --text:#0f172a; --muted:#475569;
        --accent:#16a34a; --accent-2:#2563eb; --danger:#dc2626; --shadow:0 10px 30px rgba(0,0,0,.08);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,0.15), transparent 60%),
        radial-gradient(1200px 600px at 120% 10%, rgba(34,197,94,0.15), transparent 60%),
        var(--bg);
      color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{ width:min(900px, 100%); }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    .title{ font-size:clamp(20px, 3vw, 28px); font-weight:700; }
    .round{ font-size:14px; color:var(--muted); }
    .card{
      background: linear-gradient(180deg, var(--card), var(--bg-accent));
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: clamp(18px, 3.5vw, 28px);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px;
      background: linear-gradient(180deg, rgba(96,165,250,0.18), rgba(96,165,250,0.08));
      color: var(--accent-2); font-weight:600; font-size:12px; letter-spacing:.3px; text-transform:uppercase;
      border:1px solid rgba(96,165,250,0.35);
    }
    .content{ margin-top:16px; }
    .prompt{ font-size:clamp(20px, 3vw, 26px); font-weight:700; margin:10px 0 6px; }
    .reveal{ display:grid; gap:10px; margin-top:12px; }
    .hint,.answer{
      border:1px dashed rgba(255,255,255,0.18); background:rgba(255,255,255,0.04);
      padding:14px 16px; border-radius:12px; white-space:pre-wrap;
    }
    .hint h3,.answer h3{ margin:0 0 6px 0; font-size:14px; color:var(--muted); font-weight:700; letter-spacing:.3px; text-transform:uppercase; }
    .hint p,.answer p{ margin:0; font-size:clamp(16px, 2.4vw, 20px); }
    .hidden{ display:none; }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; margin-top:18px; }
    button{
      appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:700;
      color:white; background:#374151; transition:transform .04s ease, filter .2s ease, background .2s ease;
      border:1px solid rgba(255,255,255,0.08);
    }
    button.primary{ background: linear-gradient(180deg, var(--accent), #15803d); }
    button.alt{ background: linear-gradient(180deg, var(--accent-2), #1d4ed8); }
    button.ghost{ background: transparent; color: var(--muted); border:1px dashed rgba(255,255,255,0.25); }
    button:disabled{ opacity:.6; cursor:not-allowed; filter:grayscale(.2); }
    button:active{ transform: translateY(1px) }
    .footer{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:14px; color:var(--muted); font-size:12px; }
    .steps{ display:flex; align-items:center; gap:6px; }
    .dot{
      width:10px; height:10px; border-radius:999px; background:#374151; border:1px solid rgba(255,255,255,0.12);
      box-shadow: inset 0 0 0 2px rgba(0,0,0,0.15);
    }
    .dot.on{ background: var(--accent); border-color: rgba(34,197,94,0.8) }
    .dot.ans{ background: #f59e0b; border-color: rgba(245,158,11,0.8) }
    .grid{ display:grid; grid-template-columns:1fr auto; gap:14px; align-items:center; }
    select{ padding:10px 12px; border-radius:10px; background:rgba(255,255,255,0.05); color:var(--text); border:1px solid rgba(255,255,255,0.12); font-weight:600; }
    .sr{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
    .loader{ color:var(--muted); font-size:14px; margin-top:8px; }
    .error{ color:#fca5a5; font-size:14px; margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Luck By Chance — Syngenta</div>
        <div class="round" id="roundInfo">Loading…</div>
        <div id="status" class="loader">Fetching questions from Google Sheets…</div>
      </div>
      <div class="grid">
        <label for="jump" class="sr">Jump to question</label>
        <select id="jump" disabled></select>
        <button id="randomBtn" class="alt" title="Pick a random question" disabled>Random</button>
      </div>
    </header>

    <div class="card">
      <span class="badge" id="categoryBadge">Category</span>

      <div class="content">
        <div class="prompt" id="promptText"></div>

        <div class="reveal">
          <div class="hint hidden" id="hint1">
            <h3>Hint 1</h3>
            <p id="hint1Text"></p>
          </div>
          <div class="hint hidden" id="hint2">
            <h3>Hint 2</h3>
            <p id="hint2Text"></p>
          </div>
          <div class="answer hidden" id="answer">
            <h3>Answer</h3>
            <p id="answerText"></p>
          </div>
        </div>

        <div class="controls">
          <button id="revealBtn" class="primary" disabled>Reveal next (Space)</button>
          <button id="resetBtn" class="ghost" disabled>Reset reveals</button>
          <button id="prevBtn" disabled>Previous (←)</button>
          <button id="nextBtn" disabled>Next (→)</button>
          <button id="shuffleBtn" class="ghost" title="Shuffle all questions" disabled>Shuffle order</button>
        </div>

        <div class="footer">
          <div id="sheetInfo">–</div>
          <div class="steps" aria-label="Reveal progress">
            <div class="dot" id="dotPrompt" title="Prompt"></div>
            <div class="dot" id="dotHint1" title="Hint 1"></div>
            <div class="dot" id="dotHint2" title="Hint 2"></div>
            <div class="dot" id="dotAnswer" title="Answer"></div>
          </div>
          <div>Tip: Space to reveal, ←/→ to navigate</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1) Put your published GViz JSON URL here,
    //    e.g. https://docs.google.com/spreadsheets/d/XXXX/gviz/tq?sheet=Questions&tqx=out:json
    //    or pass it via ?src=<encoded-URL> in the page URL.
    const GVIZ_URL_DEFAULT = 'REPLACE_WITH_YOUR_GVIZ_URL';

    function getSourceUrl(){
      const qp = new URLSearchParams(location.search);
      const fromQuery = qp.get('src');
      if(fromQuery){
        try{ return decodeURIComponent(fromQuery); }catch{ return fromQuery; }
      }
      return GVIZ_URL_DEFAULT;
    }

    // UI elements
    const els = {
      status: document.getElementById('status'),
      roundInfo: document.getElementById('roundInfo'),
      sheetInfo: document.getElementById('sheetInfo'),
      category: document.getElementById('categoryBadge'),
      prompt: document.getElementById('promptText'),
      hint1Wrap: document.getElementById('hint1'),
      hint2Wrap: document.getElementById('hint2'),
      answerWrap: document.getElementById('answer'),
      hint1: document.getElementById('hint1Text'),
      hint2: document.getElementById('hint2Text'),
      answer: document.getElementById('answerText'),
      revealBtn: document.getElementById('revealBtn'),
      resetBtn: document.getElementById('resetBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      shuffleBtn: document.getElementById('shuffleBtn'),
      randomBtn: document.getElementById('randomBtn'),
      jump: document.getElementById('jump'),
      dotPrompt: document.getElementById('dotPrompt'),
      dotHint1: document.getElementById('dotHint1'),
      dotHint2: document.getElementById('dotHint2'),
      dotAnswer: document.getElementById('dotAnswer')
    };

    const state = {
      QUESTIONS: [],
      order: [],
      index: 0,
      revealStep: 0,
      maxReveals: 1 // will be recalculated per question
    };

    function enableControls(on){
      [els.jump, els.randomBtn, els.revealBtn, els.resetBtn, els.prevBtn, els.nextBtn, els.shuffleBtn]
        .forEach(el => el && (el.disabled = !on));
    }

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
      return array;
    }

    function setIndex(i){
      if(i<0) i=0;
      if(i>state.order.length-1) i=state.order.length-1;
      state.index = i; state.revealStep = 0; render();
    }

    function revealNext(){ if(state.revealStep < state.maxReveals){ state.revealStep++; renderReveal(); } }
    function resetReveals(){ state.revealStep = 0; renderReveal(); }

    function calcMaxReveals(q){
      // steps after prompt = number of hints (0..2) + 1 for answer
      return (q.hints?.length || 0) + 1;
    }

    function render(){
      const q = state.QUESTIONS[state.order[state.index]];
      state.maxReveals = calcMaxReveals(q);

      els.category.textContent = q.category || 'Category';
      els.prompt.textContent = q.prompt || '';
      els.hint1.textContent = q.hints?.[0] || '';
      els.hint2.textContent = q.hints?.[1] || '';
      els.answer.textContent = q.answer || '';

      els.roundInfo.textContent = `Round ${state.index+1} of ${state.order.length}`;

      // Show/hide hint wrappers depending on content
      const hasH1 = !!(q.hints?.[0]);
      const hasH2 = !!(q.hints?.[1]);
      els.hint1Wrap.classList.toggle('hidden', !hasH1);
      els.hint2Wrap.classList.toggle('hidden', !hasH2);

      // Dots visibility
      els.dotHint1.style.display = hasH1 ? '' : 'none';
      els.dotHint2.style.display = hasH2 ? '' : 'none';

      // Populate jump menu
      els.jump.innerHTML = '';
      state.order.forEach((qi, pos)=>{
        const opt = document.createElement('option');
        const item = state.QUESTIONS[qi];
        opt.value = String(pos);
        opt.textContent = `${pos+1}. ${item.category || '—'} — ${item.prompt || ''}`.slice(0, 160);
        if(pos===state.index) opt.selected = true;
        els.jump.appendChild(opt);
      });

      renderReveal();
    }

    function renderReveal(){
      const step = state.revealStep;
      const q = state.QUESTIONS[state.order[state.index]];
      const hasH1 = !!(q.hints?.[0]);
      const hasH2 = !!(q.hints?.[1]);

      // Map dynamic steps:
      // step 0: prompt
      // step 1: first available hint (if any)
      // step 2: second hint (if any) OR answer (if only one hint)
      // last: answer
      let showH1 = false, showH2 = false, showAns = false;

      if(step >= 1 && hasH1) showH1 = true;
      if(step >= 2 && hasH2) showH2 = true;

      const minStepsForAnswer = hasH1 && hasH2 ? 3 : (hasH1 || hasH2 ? 2 : 1);
      if(step >= minStepsForAnswer) showAns = true;

      els.hint1Wrap.classList.toggle('hidden', !showH1);
      els.hint2Wrap.classList.toggle('hidden', !showH2);
      els.answerWrap.classList.toggle('hidden', !showAns);

      els.dotPrompt.classList.add('on');
      els.dotHint1.classList.toggle('on', showH1);
      els.dotHint2.classList.toggle('on', showH2);
      els.dotAnswer.classList.toggle('on', showAns);
      els.dotAnswer.classList.toggle('ans', showAns);

      const maxStep = state.maxReveals;
      els.revealBtn.disabled = step >= maxStep;
      els.revealBtn.textContent = step >= maxStep ? 'Answer shown' : 'Reveal next (Space)';
      els.prevBtn.disabled = state.index===0;
      els.nextBtn.disabled = state.index===state.order.length-1;
    }

    // Events
    els.revealBtn.addEventListener('click', revealNext);
    els.resetBtn.addEventListener('click', resetReveals);
    els.prevBtn.addEventListener('click', ()=> setIndex(state.index-1));
    els.nextBtn.addEventListener('click', ()=> setIndex(state.index+1));
    els.shuffleBtn.addEventListener('click', ()=>{ shuffle(state.order); setIndex(0); });
    els.randomBtn.addEventListener('click', ()=>{ const r=Math.floor(Math.random()*state.order.length); setIndex(r); });
    els.jump.addEventListener('change', (e)=> setIndex(parseInt(e.target.value, 10)));
    window.addEventListener('keydown', (e)=>{
      if(e.key===' '){ e.preventDefault(); revealNext(); }
      else if(e.key==='ArrowRight'){ setIndex(state.index+1); }
      else if(e.key==='ArrowLeft'){ setIndex(state.index-1); }
      else if(e.key.toLowerCase()==='r'){ resetReveals(); }
    });

    // JSONP handler for GViz
    window.google = window.google || {};
    window.google.visualization = window.google.visualization || {};
    window.google.visualization.Query = {
      setResponse: function(resp){
        try{
          if(!resp || !resp.table || !resp.table.cols) throw new Error('Invalid GViz response. Ensure the sheet is shared publicly (Anyone with the link can view) or Published to web.');

          const labels = resp.table.cols.map(c => String(c.label || '').trim().toLowerCase());
          const find = (...names) => {
            for(const n of names){
              const i = labels.indexOf(n);
              if(i !== -1) return i;
            }
            return -1;
          };

          const idI     = find('id');
          const catI    = find('category','cat','type');
          const promptI = find('prompt','question','title');
          const ansI    = find('answer','answers','solution');
          const h1I     = find('hint1','hint 1');
          const h2I     = find('hint2','hint 2');
          const hintsI  = find('hints','hint');

          if([promptI, ansI].some(i => i === -1)){
            throw new Error('Missing required columns: prompt and answer. Optional: id, category, hints or hint1/hint2.');
          }

          const rows = resp.table.rows || [];
          const data = rows.map((r, rowIdx) => {
            const get = i => (i>=0 && r.c && r.c[i] && r.c[i].v != null) ? r.c[i].v : '';

            // collect hints from either combined "hints" or hint1/hint2
            const combined = String(get(hintsI) || '').trim();
            const fromCombined = combined
              ? combined.split(/[\n|]+/).map(s => s.trim()).filter(Boolean).slice(0,2)
              : [];
            const fromSingles = [String(get(h1I) || '').trim(), String(get(h2I) || '').trim()].filter(Boolean);
            const hints = [...fromSingles, ...fromCombined].slice(0,2);

            const idRaw = get(idI);
            const idStr = String(idRaw || (rowIdx+1)); // fallback to row number

            return {
              id: idStr,
              category: String(get(catI) || '').trim(),
              prompt: String(get(promptI) || '').trim(),
              hints,
              answer: String(get(ansI) || '').trim()
            };
          }).filter(obj => obj.prompt && obj.answer);

          if(!data.length) throw new Error('No usable rows parsed. Check that prompt and answer columns have values.');

          state.QUESTIONS = data;
          state.order = [...state.QUESTIONS.keys()];
          els.status.textContent = 'Loaded from Google Sheets.';
          enableControls(true);
          setIndex(0);
        }catch(err){
          console.error(err);
          els.status.className = 'error';
          els.status.textContent = 'Failed to parse GViz JSON: ' + err.message;
        }
      }
    };

    // Inject the GViz script to bypass CORS
    (function loadGViz(){
      const src = getSourceUrl();
      const isPlaceholder = !src || /REPLACE_WITH_YOUR_GVIZ_URL/i.test(src);
      if(isPlaceholder){
        els.status.className='error';
        els.status.innerHTML = 'GViz URL not set. Edit GVIZ_URL_DEFAULT in the HTML, or open this file with ?src=<encoded-gviz-url>.';
        return;
      }
      els.sheetInfo.textContent = 'Source: ' + (new URL(src, location.href)).host;
      const s = document.createElement('script');
      // Ensure out:json so the response calls google.visualization.Query.setResponse(...)
      const url = new URL(src, location.href);
      const tqx = url.searchParams.get('tqx');
      if(!tqx){ url.searchParams.set('tqx','out:json'); }
      s.src = url.toString();
      s.onerror = () => {
        els.status.className='error';
        els.status.textContent='Failed to load Google Sheets GViz URL. Check sharing (Anyone with the link can view) and the sheet name/gid.';
      };
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
